# コードレビュー報告書: cospec ドキュメント vs 実装

## 概要
この報告書では、cospecプロジェクトのドキュメントと実装との間の不整合、不足機能、およびガイドライン違反を特定します。

## 不整合

### ディレクトリ構造
- **ドキュメント**: `cospec/` をルートディレクトリとして、`main.py`、`core/` などを配置
- **実装**: 実際の構造では `src/cospec/` がパッケージルートとして使用されているが、ドキュメントには反映されていない

### 欠けているコンポーネント
- **エージェントシステム**: BLUEPRINT.md で説明されている3つの専門エージェント（Reviewer、Interviewer、Coder）は実装されていない
- **ディレクトリ構造**: BLUEPRINT.md で言及されている `prompts/` および `templates/` ディレクトリは存在しない
- **外部ツール**: reviewコマンドの実装は外部ツールを呼び出すだけで、ドキュメントで説明されている分析ロジックを実装していない

## 不足機能

### 完全に欠けているコマンド (SPEC.md より)
1. **FR-002: `hear` (要件ヒアリング)** - 完全に実装されていない
   - 要件: 対話形式で SPEC.md の曖昧さを解消する
   - ドキュメント: "対話形式で SPEC.md の曖昧さを解消する"

2. **FR-003: `test-gen` (テスト生成)** - 完全に実装されていない  
   - 要件: SPEC.md の要件からテストケースを抽出し、テストコードを生成する
   - ドキュメント: "SPEC.md の要件からテストケースを抽出し、テストコードを生成する"

3. **FR-005: `status` (状況確認)** - 10% 実装
   - 現在: 静的な "Inception" メッセージ
   - 必要: "現在のフェーズ（Spec未定/Test失敗/Impl完了）を表示し、次のアクションを提案する"

### 不完全な実装
1. **FR-001: `init` (プロジェクト初期化)** - 30% 実装
   - 欠けている: `OverviewDesignThinking.md`、`OverviewCodingTestingThinking.md` などの「思想」ファイルのコピー
   - 欠けている: プロジェクトの実際のテンプレートを使用
   - ドキュメント違反: "ガイドライン注入: OverviewDesignThinking.md 等の「思想」ファイルを自動配置する"

2. **FR-004: `review` (整合性レビュー)** - 40% 実装
   - 現在: 基本的な外部ツール実行
   - 必要: 不足、不整合、ガイドライン準拠に関する詳細な分析
   - 欠けている: トークン効率、コンテキストウィンドウ管理

## ガイドライン違反

### OverviewCodingTestingThinking.md 違反
1. **Docstringの欠如**: main.py の関数に適切なdocstringが欠けている（ガイドライン要件）
2. **依存性注入の欠如**: 外部依存関係が直接呼び出され、モック可能設計に違反
3. **Pydanticモデルの不適切使用**: 設定は存在するが、適切なデータ検証パターンが欠けている
4. **モックメカニズムの欠如**: 外部I/O用のテスト可能インターフェースが存在しない

### アーキテクチャ違反
1. **Small Context 原則**: Analyzer (`analyzer.py:35-45`) はトークン管理なしにソースファイル全体を読み込む
2. **インターフェース境界**: ビジネスロジックと外部操作の明確な分離が欠けている
3. **Test-Driven Generation**: TDGワークフローが実装されていない（ガイドラインの中心）

### コード品質の問題
1. **型ヒントの不整合**: `List[str]` は使用されているが、`Dict` は仕様なしで使用されている
2. **エラーハンドリング**: 構造化されたアプローチなしの基本的な例外処理
3. **ロギングの欠如**: 自己文書化コードの実践が不十分

## 修正提案

### 高優先度修正
1. **欠けているコアファイルの実装**: `agent.py`、`reporter.py`、`prompts/`、`templates/` ディレクトリの作成
2. **`init` コマンドの強化**: 実際のガイドラインファイルをコピーするように修正
3. **`hear` および `test-gen` コマンドの実装** (FR-002, FR-003)

### 中優先度修正
1. **エージェントシステムの実装**: BLUEPRINT.md に従ったReviewer/Interviewer/Coderエージェント
2. **`review` コマンドの強化**: 外部ツール委譲ではなく実際の分析ロジックの実装
3. **依存性注入の追加**: テストとモックの準拠のため

### 低優先度修正
1. **TDGワークフローの実装**: テスト駆動生成の実装
2. **包括的なエラーハンドリング**: コードベース全体での構造化アプローチ
3. **トークン効率の実装**: 指定された通りのコンテキストウィンドウ管理

## 結論
現在の実装は、ドキュメントされた仕様の約15%しか実装されておらず、主要なアーキテクチャコンポーネント、5つの機能要件のうち3つ、および複数のガイドライン標準が欠如しています。ドキュメントと実装のギャップを埋めるための大幅な開発が必要です。
